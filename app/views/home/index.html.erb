<% total_users = 200 %>

<script>
  "use strict";

  var total_users = <%= total_users %>;
  var paused = false;

  function start_user_requests() {
    var user_ids = _.shuffle(_.range(1, total_users + 1)),
        i = 0,
        user_id = null;
      
    for (i in user_ids) {
      user_request(user_ids[i]);        
    }
  }
  
  function handle_response(user_id, html) {
    var $user = $("#user_" + user_id),
        $userview_wrapper = $user.closest(".userview-wrapper");
    $user.html(html);
    $userview_wrapper.addClass('new');
  }

  function user_request(user_id) {
    var $user = $("#user_" + user_id),
        $userview_wrapper = $user.closest(".userview-wrapper");
    if (paused) {
      $userview_wrapper.removeClass('new');
      return;
    }
    else {
      setTimeout(function() { $userview_wrapper.removeClass('new') }, 500);
    }
    $.ajax(
      "/features",
      {
        headers: {
          // Very very basic authentication :)
          Authorization: user_id
        }
      }
    ).success(function(html) {
      handle_response(user_id, html);      
      // New request in 1 second
      setTimeout(function() { user_request(user_id) }, rand_from_range(1000, 2000));

    }).fail(function(xhr) {
      handle_response(user_id, "Response failed");  
      // If we failed, try again in 3 seconds
      setTimeout(function() { user_request(user_id) }, rand_from_range(2000, 5000));
    });
  }
  
  $(".pause").live("click", function() {
    toggle_paused();
    $(this).html(paused ? "Start" : "Pause");
  })

  function rand_from_range(from, to) {
    return Math.floor((Math.random()*(to-from))+from);
  }

  function toggle_paused() {
    paused = ! paused;
    if ( ! paused ) {
      start_user_requests();
    }
  }

  (function() {
    start_user_requests();
  })();

</script>

<h1>User Views</h1>

<p>Here is the view of this application from the perspective of <%= total_users %> different users. Each user has different features enabled. This site is using FluidFeatures.com to enable / disable features for this user-base.</p>

<!-- Feature images and descriptions -->
<div class="features">
  <h2>Controls</h2>
  <div class="controls">
    <button class="pause">Pause</button>
  </div>
  <h2>Features</h2>
  <% @feature_names.each do |feature_name| %>
    <div class="feature">
      <img src="/img/feature-icons/<%= feature_name %>.png">
      <%= feature_name %>
    </div>
  <% end %>
</div>

<!-- One window for each user -->
<div class="users">
  <% (1..total_users).each do |user_id| %>
    <div class="userview-wrapper">
      User: <%= user_id %>
      <div class="userview" id="user_<%= user_id %>"></div>
    </div>
  <% end %>
</div>
